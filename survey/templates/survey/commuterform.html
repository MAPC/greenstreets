{% extends "base.html" %}
{% load i18n %}

{% block style %}
	<link href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/base/jquery-ui.css" rel="stylesheet" type="text/css"/>
	<link rel="stylesheet" href="{{ STATIC_URL }}js/chosen/chosen/chosen.css">
{{ block.super }}
{% endblock style %}

{% block javascript %}

<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/jquery-ui.min.js"></script>
<script src="{{ STATIC_URL }}js/jquery.shuffle.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}js/jquery.cookie.js" type="text/javascript"></script>

<script src="{{ STATIC_URL }}js/chosen/chosen/chosen.jquery.min.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}css/bootstrap/js/bootstrap-modal.js" type="text/javascript"></script>
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false&language={{ LANGUAGE_CODE }}"></script> 
<script type="text/javascript">

$(document).ready(function() {

	// check if cookies are enabled
	$.cookie('test_cookie', 'testing', { path: '/' });
	if ($.cookie('test_cookie') !== 'testing') {
		alert("Please allow cookies for this site in your browser, otherwise the survey form might not work. Thank you!");
	}
	
	// initiate chosen dropdown UIs	
	$(".chzn-select").chosen();

	var boston = new google.maps.LatLng(42.357778, -71.061667);
	var work = new google.maps.LatLng(42.37, -71.08);
	var home = new google.maps.LatLng(42.36, -71.10);
	
	var mapOptions = {
		zoom: 11,
		mapTypeId: google.maps.MapTypeId.ROADMAP,
		center: home
	};
 
	var map = new google.maps.Map(document.getElementById("map_canvas"),
		mapOptions);
    
    // home and work place marker
	var iconHome = "{{ STATIC_URL }}img/home.png";
	var markerHome = new google.maps.Marker({
		map:map,
		title:"Please drag & drop the marker to the intersection closest to your home.",
		draggable:true,
		animation: google.maps.Animation.DROP,
		position: home,
		icon: iconHome
	});
	// animation
	google.maps.event.addListener(markerHome, 'click', toggleBounce);
	// track marker dragging		
	google.maps.event.addListener(markerHome, 'dragend', function() {
		// write loc coord to hidden geometry field (in WGS84)
		$("#id_home_location").val("POINT (" + markerHome.position.lng() + " " +  markerHome.position.lat() + ")");
	});
	var iconEmployer = "{{ STATIC_URL }}img/factory.png";
	var markerEmployer = new google.maps.Marker({
		map: map,
		title: "Please drag the marker to the location of your work-place.",
		position: work,
		draggable: true,
		animation: google.maps.Animation.DROP,
		icon: iconEmployer
	});
	// animation
	google.maps.event.addListener(markerEmployer, 'click', toggleBounce);
	// track marker dragging		
	google.maps.event.addListener(markerEmployer, 'dragend', function() {
		// write loc coord to hidden geometry field (in WGS84)
		work = this.getPosition();
		$("#id_work_location").val("POINT (" + this.position.lng() + " " +  this.position.lat() + ")");
		getEmployers({
			'lat': work.lat(), 
			'lng': work.lng(),
			'radius': 1609.344 // in meters
		});
	});
	
	var toggleBounce = function () {
		if (markerH.getAnimation() != null) {
			markerH.setAnimation(null);
		} else {
			markerH.setAnimation(google.maps.Animation.BOUNCE);
		}
	}
	
    // random order of modes
    $("#id_to_work_today, #id_from_work_today, #id_to_work_yesterday, #id_from_work_yesterday").shuffle();
    
    // hide and show optional street intersection fields
    $("#intersection_fields").hide();
    
    $("#intersection_fields_link").click(function () {
    	$("#intersection_fields").toggle(500);
		return false;
    });
    
    $("#home-town-select").change(function() {
    	var town = $("#home-town-select option:selected").val();
		// simple street type-ahead to limit street options
		$.getJSON("/town/" + town + "/streets/", function(streets) {
			$("input#id_home_street, input#id_home_cross_st").autocomplete({
				source: streets,
				minLength: 3
			});
		});
    });
    
    // select employer
    // $("#employer_fields").hide();

    $("#work-town-select").change(function() {
    	var town = $("#work-town-select option:selected").val();
    	
    	if (town !== "") {
    		
    		// add spinner
    		var spinner = $(document.createElement("img"))
    		.attr({ "src": "{{ STATIC_URL }}img/spinner.gif", "width": "24", "height": "24"})
    		.css({ "margin-left" : "10px"})
    		.insertAfter($("#work-town-select"));
    		
    		var employer_locations = {};
    		
    		$.getJSON("/town/" + town + "/employers/", function(employers) {
    			// clear previouse dropdown options
				$("#id_employer option").remove();
				$("<option selected='selected' value=''>---------</option>").appendTo("#id_employer");
    			$.each(employers, function(key, employer) {
					$("<option value='" + employer.infousa_id + "'>" + employer.name + "</option>").appendTo("#id_employer");
					employer_locations[employer.infousa_id] = employer.latlon;
				});
				// bind change event to select input
				$("#id_employer").change(function () {
    				var infousa_id = $("#id_employer option:selected").val();
    				// var name = $("#employer-select option:selected").text();
    				if (infousa_id === "") {
    					$("#id_work_location").val("POINT (0.0000000000000000 0.0000000000000000)");
    					work = map.getCenter();
    				} else {
    					var coords = employer_locations[infousa_id];
    					work = new google.maps.LatLng(coords.split(" ")[0], coords.split(" ")[1]);
    					$("#id_work_location").val("POINT (" + coords.split(" ")[1] + " " +  coords.split(" ")[0] + ")");
    				}
    				markerEmployer.setPosition(work);
    			});
    			// show select input
				$("#employer_fields").show(500, function() {
					// remove spinner
					spinner.remove();
				});
    		});
    		
    	}
    });
	
	// impact buttons
	var directionsService = new google.maps.DirectionsService();
	$("#button_co2").click(function() {
		
		var mode_to = $("#id_to_work_today option:selected").val();
		var mode_from = $("#id_from_work_today option:selected").val();
		
		var legs = 2; // to and from work
		var co2_modes = ["", "c", "cp"];
		// jQuery.inArray(mode_to, co2_modes)
		if (jQuery.inArray(mode_to, co2_modes) > -1 || jQuery.inArray(mode_from, co2_modes) > -1) legs = 1;
		if (jQuery.inArray(mode_to, co2_modes) > -1 && jQuery.inArray(mode_from, co2_modes) > -1) legs = 0;
		// get distance for car mode
		if (legs !== 0) {
	  		var request = {
				origin: markerHome.getPosition(),
				destination: markerEmployer.getPosition(),
				unitSystem: google.maps.UnitSystem.METRIC,
				travelMode: google.maps.TravelMode.DRIVING
			};
			directionsService.route(request, function(result, status) {
				if (status == google.maps.DirectionsStatus.OK) {
					// EPA standard: 0.41kg CO2 per mile driven (convert to lbs and meters)
					$("#saved_co2").text(Math.round(result.routes[0].legs[0].distance.value * legs * 0.41 * 2.20462262 / 1609.344) + " lbs");
					$("#id_distance").val(result.routes[0].legs[0].distance.value * legs);
				}
			});
		} else {
			$("#saved_co2").text("No saved CO2 emmissions today");
		}
		return false;
	});
	$("#button_calories").click(function() {
		var weight = parseFloat($("#id_weight").val());
		$("#id_weight").text(weight); // return float value of weight
		var calories = 0;
		var duration = 0;
		var mode_to = $("#id_to_work_today option:selected").val();
		var mode_from = $("#id_from_work_today option:selected").val();
		
		switch(mode_to) {
			case "w":
				var travelmode_to = google.maps.TravelMode.WALKING;
				var mets_to = 2.5;
				break;
			case "b":
				var travelmode_to = google.maps.TravelMode.BICYCLING;
				var mets_to = 8;
				break;
			case "o":
				var travelmode_to = google.maps.TravelMode.BICYCLING;
				var mets_to = 12; // we estimate the same mets as for b but 50% more time
				break;
			default:
				var mets_to = 0;
		}
		switch(mode_from) {
			case "w":
				var travelmode_from = google.maps.TravelMode.WALKING;
				var mets_from = 2.5;
				break;
			case "b":
				var travelmode_from = google.maps.TravelMode.BICYCLING;
				var mets_from = 8;
				break;
			case "o":
				var travelmode_from = google.maps.TravelMode.BICYCLING;
				var mets_from = 12; // we estimate the same mets as for b but 50% more time
				break;
			default:
				var mets_from = 0;
		}
		if (weight > 0) {
			// id_duration
			if (mets_to !== 0) {
		  		var request_to = {
					origin: markerHome.getPosition(),
					destination: markerEmployer.getPosition(),
					unitSystem: google.maps.UnitSystem.METRIC,
					travelMode: travelmode_to
				};
				directionsService.route(request_to, function(result, status) {
					if (status == google.maps.DirectionsStatus.OK) {
						duration += result.routes[0].legs[0].duration.value;
						//calories = (mets/2.2) * weight * hours duration
						calories += duration / 3600 * weight * mets_to / 2.2;
						$("#burned_calories").text(Math.round(calories));
						$("#id_duration").val(duration);
					}
				});
			}
			if (mets_from !== 0) {
		  		var request_from = {
					origin: markerHome.getPosition(),
					destination: markerEmployer.getPosition(),
					unitSystem: google.maps.UnitSystem.METRIC,
					travelMode: travelmode_from
				};
				directionsService.route(request_from, function(result, status) {
					if (status == google.maps.DirectionsStatus.OK) {
						duration += result.routes[0].legs[0].duration.value;
						//calories = (mets/2.2) * weight * hours duration
						calories += duration / 3600 * weight * mets_from / 2.2;
						$("#burned_calories").text(Math.round(calories));
						$("#id_duration").val(duration);
					}
				});
			}
			if (mets_from === 0 && mets_to === 0) { 
				// car or transit doesn't burn calories
				$("#burned_calories").text("Too few calories burned today, try walking, biking or other active transportation modes!");
			}
		} else {
			$("#burned_calories").text("Please enter your weight in the above field");
		}
		return false;
	});

	// error modal
	$("#form_error_modal").modal({
		backdrop: true
	});

	// receives an array of points and adjusts the map extent accordingly
	var setMapBounds = function (points) {
		
		var mapbounds = new google.maps.LatLngBounds();
		$.each(points, function(index, point) { 
			mapbounds.extend(point);
		});
		map.fitBounds(mapbounds);
	}

	// trigger geocoding given address and move markers on map
	$("#locate_home, #locate_work").click(function() {
		// home or work
		var address_type = this.id.split("_")[1];
		geocodeAddress(address_type);
	});
	$("#home-address, #work-address").keyup(function(e) {
		// key = enter
        if(e.which == 13) {
        	// home or work
        	var address_type = this.id.split("-")[0];
			geocodeAddress(address_type);
        }
    });

    // calls Google's geocoder, queries employers and moves marker
	var geocodeAddress = function(address_type) {

		var geocoder = new google.maps.Geocoder();
		var address = $("#" + address_type + "-address").val();
		
		geocoder.geocode( { 'address': address }, function(results, status) {
			if (status == google.maps.GeocoderStatus.OK) {

				if (address_type === "home") {
					home = results[0].geometry.location;
					markerHome.setPosition(home);
					$("#id_home_location").val("POINT (" + markerHome.position.lng() + " " +  markerHome.position.lat() + ")");
					setMapBounds([markerHome.position, markerEmployer.position]);
				}
				if (address_type === "work") {
					work = results[0].geometry.location;
					markerEmployer.setPosition(work);
					$("#id_work_location").val("POINT (" + markerEmployer.position.lng() + " " +  markerEmployer.position.lat() + ")");
					setMapBounds([markerHome.position, markerEmployer.position]);
					// search for employers
					getEmployers({
						'lat': work.lat(), 
						'lng': work.lng(),
						'radius': 1609.344 // in meters
					});
				}		
										
			} else {
				$("#form_error_msg").html("<p>Sorry, we couldn't find your address.</p>");
				$("#form_error_modal").modal("show");
			}
		});
	}

	// get employer JSON based on a location
	// data = { 'lat': latitute, 'lng': longitude, 'radius': radius in meters }
	var getEmployers = function (data) {
	
		var employer_locations = {};
		$.get("/employers/", data,
		function(employers){
			
			var employer_locations = {};

			// clear previouse dropdown options and events
			// $("#id_employer").unbind();
			$("#id_employer option").remove();
			// build dropdown
			$("<option selected='selected' value=''>---------</option>").appendTo("#id_employer");
			$.each(employers, function(key, employer) {
				$("<option value='" + employer.infousa_id + "'>" + employer.name + "</option>")
				.data('latlon', employer.latlon)
				.appendTo("#id_employer");
			});
			// update list
			$("#id_employer").trigger("liszt:updated");
			// bind change event to select input
			$("#id_employer").chosen().change(function () {
				var latlon = $("#id_employer option:selected").data('latlon');
				if (latlon !== undefined) {
					work = new google.maps.LatLng(latlon.split(" ")[0], latlon.split(" ")[1]);
					$("#id_work_location").val("POINT (" + latlon.split(" ")[1] + " " + latlon.split(" ")[0] + ")");
					markerEmployer.setPosition(work);
					setMapBounds([markerHome.position, markerEmployer.position]);
				}
			});

		}, "json");
	}

	// form validation
	$("#commuterform").submit(function() {
		
		// check for valid email
		var emailReg = /^([\w-\.]+@([\w-]+\.)+[\w-]{2,4})?$/;
		if (emailReg.test($("#id_email").val()) === false) {
			$("#form_error_msg").html("<p>Please provide a valid email address.</p>");
			$("#form_error_modal").modal("show");
			return false;
		}

		// check locations
		if ($("#id_home_location").val() === "POINT (0.0000000000000000 0.0000000000000000)") {
			// no marker and no intersection
			if ($("#id_home_street").val() === "" || $("#id_home_cross_st").val() === "" ) {
				$("#form_error_msg").html("<p>Please provide your home location.</p>");
				$("#form_error_modal").modal("show");
				return false;
			}
		}
		if ($("#id_work_location").val() === "POINT (0.0000000000000000 0.0000000000000000)") {
			$("#form_error_msg").html("<p>Please provide your work-place location.</p>");
			$("#form_error_modal").modal("show");
			return false;
		}
		if ($("#id_to_work_today option:selected").val() === "" && $("#id_from_work_today option:selected").val() === "") {
			$("#form_error_msg").html("<p>Please tell us how you commuted to and from work today.</p>");
			$("#form_error_modal").modal("show");
			return false;
		}
   });
    
});

</script>

{% endblock %}

{% block body %}

<h2>Check-in your commute to work!</h2>

<p>A check-in helps us monitor the impact of our initiative and involves only a few quick steps.</p>

<form id="commuterform" action="." method="POST">
	
	{% csrf_token %}

	<fieldset>
    	<h3>1. Please tell us about yourself:</h3>
    	<div class="clearfix">
			<label>Your name (optional)</label><div class="input">{{ commuterform.name }}</div>
		</div>
		<div class="clearfix">
			<label>Your email (<span class="required_field">required</span>)</label><div class="input">{{ commuterform.email }}<span class="help-block">We respect your privacy and won't share any information.</span></div>
		</div>
		<div class="clearfix">
			<label>I would like to subscribe to your monthly newsletter.</label><div class="input">{{ commuterform.newsletter }}</div> 
		</div>
    </fieldset>

	<fieldset>
		
		<h3>2. Please tell us about your commute (<span class="required_field">required</span>):</h3>

		<p>Please tell us where your commute started and ended today. Please use the address fields or drag and drop the icons.</p>

		<div class="clearfix">
			<label>Enter your home address:</label><div class="input"><img src="{{ STATIC_URL }}img/home.png" height="26" alt="Home marker" class="marker"> <input type="text" id="home-address" /> <a id="locate_home" class="btn">Locate</a></div>
		</div>
		<div class="clearfix">
			<label>Enter your work address:</label><div class="input"><img src="{{ STATIC_URL }}img/factory.png" height="26" alt="Home marker" class="marker"> <input type="text" id="work-address" /> <a id="locate_work" class="btn">Locate</a></div>
		</div>

		<div id="map_canvas">map div</div>
		<p id="map_legend" class="small"><img src="{{ STATIC_URL }}img/home.png" height="20" alt="Home marker" > {% blocktrans %}for home{% endblocktrans %}, and <img src="{{ STATIC_URL }}img/factory.png" height="20" alt="Home marker" > for workplace</p>
	
		{{ commuterform.home_location }}
		{{ commuterform.work_location }}
		{{ commuterform.distance }}
		{{ commuterform.duration }}
		
		<h4>How did you commute today, on Walk/Ride Day (<span class="required_field">required</span>)?</h3>

		<div class="clearfix">
			<label>To work today:</label> <div class="input">{{ commuterform.to_work_today }}</div>
			<label>From work today:</label><div class="input">{{ commuterform.from_work_today }}<span class="help-block">Please refer to the longest leg of your commute.</span></div>

		</div>

		<h4>How do you normally commute?</h3>

		<div class="clearfix">
			<label>To work on a usual day:</label> <div class="input">{{ commuterform.to_work_yesterday }}</div>
			<label>From work on a usual day:</label><div class="input">{{ commuterform.from_work_yesterday }}<span class="help-block">Please refer to the longest leg of your commute.</span></div>
		</div>

		<div class="alert-message block-message info">

			<h4>See the impact you had today:</h4><span class="help-block"></span>
			
			<div class="clearfix">
				<label>Saved CO<sub>2</sub> emissions:</label> <div class="input" id="saved_co2">Click button below to calculate</div>
				<button id="button_co2" class="btn impact">Calculate CO2</button>
				<span class="help-block impact">Per EPA standards and assumptions, compared to commuting by car, alone.</span>
			</div>
			
			<div class="clearfix">
				{{ commuterform.weight.errors }}
				<label>Your weight [lbs]:</label> <div class="input">{{ commuterform.weight }}</div>
				<label>Your burned calories:</label> <div id="burned_calories" class="input">Enter your weight and click button below to calculate</div>
				<button id="button_calories" class="btn impact">Calculate Calories</button>
				<span class="help-block impact">Per <a target="_blank" href="http://prevention.sph.sc.edu/tools/compendium.htm">The Compendium of Physical Activities</a>, compared to commuting by car or transit.</span>
			</div>

		</div>
		
	</fieldset>
		
	<fieldset>
		
		<h3>3. Please tell us where you work:</h3>
		
		<div id="employer_fields">
			<div class="clearfix">
				<label>Please select your workplace:</label>
				<div class="input">
					<select class="chzn-select" id="id_employer" name="employer" tabindex="2">
						<option selected="selected" value="">Please specify your work-location first.</option>
					</select>
				</div>
			</div>
			<div class="clearfix">
				<label>other: </label><div class="input">{{ commuterform.other_employer }}</div>
			</div>
		</div>

	</fieldset>
	
	<fieldset>

		<h3>4. Get involved!</h3>

		<div class="clearfix">
			<label>My workplace, school or other organization would like to get involved and promote Walk/Ride Days, and I will be the on-site contact person.</label><div class="input">{{ commuterform.coordinator }}</div>
		</div>
		<div class="clearfix">
			<label>I would like to help Green Streets by volunteering in another capacity.</label><div class="input">{{ commuterform.volunteer }}</div>
		</div>

		<div class="clearfix">
			<label>My workplace would like to sponsor Walk/Ride Days at a local school or event.</label><div class="input">{{ commuterform.potential_sponsor }}</div>
		</div>

		<div class="clearfix">
			<label>I will take advantage of incentives offered by Walk/Ride Day Retail Partners to participants.</label><div class="input">{{ commuterform.sponsor }}</div>
		</div>
		
		<div class="clearfix">
			<label>Additional thoughts or feedback in general, about Walk/Ride Days or your green commute:</label><div class="input">{{ commuterform.feedback }}</div>
		</div>

	</fieldset>	

	<button id="button_submit" type="submit" class="btn large primary">Check-in your commute!</button>

</form>

<div id="form_error_modal" class="modal hide fade">
	<div class="modal-header">
		<a href="#" class="close">&times;</a>
		<h3>Error</h3>
	</div>
	<div id="form_error_msg" class="modal-body"></div>
</div>

{% endblock %}