{% extends "base.html" %}
{% load i18n %}

{% block javascript %}
<link href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/base/jquery-ui.css" rel="stylesheet" type="text/css"/>
<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/jquery-ui.min.js"></script>
<script src="{{ STATIC_URL }}js/jquery.shuffle.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}js/jquery.cookie.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}css/bootstrap/js/bootstrap-modal.js" type="text/javascript"></script>
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false&language={{ LANGUAGE_CODE }}"></script> 
<script type="text/javascript">

$(document).ready(function() {
	
	// check if cookies are enabled
	$.cookie('test_cookie', 'testing', { path: '/' });
	if ($.cookie('test_cookie') !== 'testing') {
		alert("Please allow cookies for this site in your browser, otherwise the survey form might not work. Thank you!");
	}
	
	var boston = new google.maps.LatLng(42.357778, -71.061667);
	var work = new google.maps.LatLng(42.37, -71.08);
	var home = new google.maps.LatLng(42.36, -71.10);
	
	var mapOptions = {
		zoom: 11,
		mapTypeId: google.maps.MapTypeId.ROADMAP,
		center: home
	};
 
	var map = new google.maps.Map(document.getElementById("map_canvas"),
		mapOptions);
    
    // home and work place marker
	var iconHome = "{{ STATIC_URL }}img/home.png";
	var markerHome = new google.maps.Marker({
		map:map,
		title:"Please drag & drop the marker to the intersection closest to your home",
		draggable:true,
		animation: google.maps.Animation.DROP,
		position: home,
		icon: iconHome
	});
	// animation
	google.maps.event.addListener(markerHome, 'click', toggleBounce);
	// track marker dragging		
	google.maps.event.addListener(markerHome, 'dragend', function() {
		// write loc coord to hidden geometry field (in WGS84)
		$("#id_home_location").val("POINT (" + markerHome.position.lng() + " " +  markerHome.position.lat() + ")");
	});
	var iconEmployer = "{{ STATIC_URL }}img/factory.png";
	var markerEmployer = new google.maps.Marker({
		map: map,
		title: "your work place",
		position: work,
		draggable: true,
		icon: iconEmployer
	});
	// animation
	google.maps.event.addListener(markerEmployer, 'click', toggleBounce);
	// track marker dragging		
	google.maps.event.addListener(markerEmployer, 'dragend', function() {
		// write loc coord to hidden geometry field (in WGS84)
		$("#id_work_location").val("POINT (" + markerEmployer.position.lng() + " " +  markerEmployer.position.lat() + ")");
	});
	
	function toggleBounce() {
		if (markerH.getAnimation() != null) {
			markerH.setAnimation(null);
		} else {
			markerH.setAnimation(google.maps.Animation.BOUNCE);
		}
	}
	
    // random order of modes
    $("#id_to_work_today, #id_from_work_today, #id_to_work_yesterday, #id_from_work_yesterday").shuffle();
    
    // hide and show optional street intersection fields
    $("#intersection_fields").hide();
    
    $("#intersection_fields_link").click(function () {
    	$("#intersection_fields").toggle(500);
		return false;
    });
    
    $("#home-town-select").change(function() {
    	var town = $("#home-town-select option:selected").val();
		// simple street type-ahead to limit street options
		$.getJSON("/town/" + town + "/streets/", function(streets) {
			$("input#id_home_street, input#id_home_cross_st").autocomplete({
				source: streets,
				minLength: 3
			});
		});
    });
    
    // select employer
    $("#employer_fields").hide();

    $("#work-town-select").change(function() {
    	var town = $("#work-town-select option:selected").val();
    	
    	if (town !== "") {
    		
    		// add spinner
    		var spinner = $(document.createElement("img"))
    		.attr({ "src": "{{ STATIC_URL }}img/spinner.gif", "width": "24", "height": "24"})
    		.css({ "margin-left" : "10px"})
    		.insertAfter($("#work-town-select"));
    		
    		var employer_locations = {};
    		
    		$.getJSON("/town/" + town + "/employers/", function(employers) {
    			// clear previouse dropdown options
				$("#employer-select option").remove();
				$("<option selected='selected' value=''>---------</option>").appendTo("#employer-select");
    			$.each(employers, function(key, employer) {
					$("<option value='" + employer.infousa_id + "'>" + employer.name + "</option>").appendTo("#employer-select");
					employer_locations[employer.infousa_id] = employer.latlon;
				});
				// bind change event to select input
				$("#employer-select").change(function () {
    				var infousa_id = $("#employer-select option:selected").val();
    				// var name = $("#employer-select option:selected").text();
    				var coords = employer_locations[infousa_id];
    				var location = new google.maps.LatLng(coords.split(" ")[0], coords.split(" ")[1]);
    				
    				markerEmployer.setPosition(location)
    				
    			});
    			// show select input
				$("#employer_fields").show(500, function() {
					// remove spinner
					spinner.remove();
				});
    		});
    		
    	}
    });
	
	// impact buttons
	var directionsService = new google.maps.DirectionsService();
	$("#button_co2").click(function() {
		
		var mode_to = $("#id_to_work_today option:selected").val();
		var mode_from = $("#id_from_work_today option:selected").val();
		
		var legs = 2; // to and from work
		if (mode_to === "cp" || mode_from === "cp") legs = 1;
		if (mode_to === "cp" && mode_from === "cp") legs = 0;
		if (mode_to === "" && mode_from === "") legs = 0;
		// get distance for car mode
		if (legs !== 0) {
	  		var request = {
				origin: markerHome.getPosition(),
				destination: markerEmployer.getPosition(),
				unitSystem: google.maps.UnitSystem.METRIC,
				travelMode: google.maps.TravelMode.DRIVING
			};
			directionsService.route(request, function(result, status) {
				if (status == google.maps.DirectionsStatus.OK) {
					// EPA standard: 0.41kg CO2 per mile driven (convert to lbs and meters)
					$("#saved_co2").text(Math.round(result.routes[0].legs[0].distance.value * legs * 0.41 * 2.20462262 / 1609.344) + " lbs");
					$("#id_distance").val(result.routes[0].legs[0].distance.value * legs);
				}
			});
		} else {
			$("#saved_co2").text("No saved CO2 emmissions today");
		}
		return false;
	});
	$("#button_calories").click(function() {
		var weight = parseFloat($("#id_weight").val());
		$("#id_weight").text(weight); // return float value of weight
		var calories = 0;
		var duration = 0;
		var mode_to = $("#id_to_work_today option:selected").val();
		var mode_from = $("#id_from_work_today option:selected").val();
		
		switch(mode_to) {
			case "w":
				var travelmode_to = google.maps.TravelMode.WALKING;
				var mets_to = 2.5;
				break;
			case "b":
				var travelmode_to = google.maps.TravelMode.BICYCLING;
				var mets_to = 8;
				break;
			case "o":
				var travelmode_to = google.maps.TravelMode.BICYCLING;
				var mets_to = 12; // we estimate the same mets as for b but 50% more time
				break;
			default:
				var mets_to = 0;
		}
		switch(mode_from) {
			case "w":
				var travelmode_from = google.maps.TravelMode.WALKING;
				var mets_from = 2.5;
				break;
			case "b":
				var travelmode_from = google.maps.TravelMode.BICYCLING;
				var mets_from = 8;
				break;
			case "o":
				var travelmode_from = google.maps.TravelMode.BICYCLING;
				var mets_from = 12; // we estimate the same mets as for b but 50% more time
				break;
			default:
				var mets_from = 0;
		}
		// id_duration
		if (mets_to !== 0) {
	  		var request_to = {
				origin: markerHome.getPosition(),
				destination: markerEmployer.getPosition(),
				unitSystem: google.maps.UnitSystem.METRIC,
				travelMode: travelmode_to
			};
			directionsService.route(request_to, function(result, status) {
				if (status == google.maps.DirectionsStatus.OK) {
					duration += result.routes[0].legs[0].duration.value;
					//calories = (mets/2.2) * weight * hours duration
					calories += duration / 3600 * weight * mets_to / 2.2;
					$("#burned_calories").text(Math.round(calories));
					$("#id_duration").val(duration);
				}
			});
		}
		if (mets_from !== 0) {
	  		var request_from = {
				origin: markerHome.getPosition(),
				destination: markerEmployer.getPosition(),
				unitSystem: google.maps.UnitSystem.METRIC,
				travelMode: travelmode_from
			};
			directionsService.route(request_from, function(result, status) {
				if (status == google.maps.DirectionsStatus.OK) {
					duration += result.routes[0].legs[0].duration.value;
					//calories = (mets/2.2) * weight * hours duration
					calories += duration / 3600 * weight * mets_from / 2.2;
					$("#burned_calories").text(Math.round(calories));
					$("#id_duration").val(duration);
				}
			});
		}
		if (calories === 0) $("#burned_calories").text("No burned calories today");
		return false;
	});
	
	// error modal
	$("#form_error_modal").modal({
		backdrop: true
	});
	// form validation
	$("#adultform").submit(function() {
		// check locations
		if ($("#id_home_location").val() === "POINT (0.0000000000000000 0.0000000000000000)") {
			// no marker and no intersection
			if ($("#id_home_street").val() === "" || $("#id_home_cross_st").val() === "" ) {
				$("#form_error_msg").html("<p>Please provide your home location.</p>");
				$("#form_error_modal").modal("show");
				return false;
			}
		}
		if ($("#id_work_location").val() === "POINT (0.0000000000000000 0.0000000000000000)") {
			$("#form_error_msg").html("<p>Please provide your work-place location.</p>");
			$("#form_error_modal").modal("show");
			return false;
		}
		if ($("#id_to_work_today option:selected").val() === "" && $("#id_from_work_today option:selected").val() === "") {
			$("#form_error_msg").html("<p>Please tell us how you commuted to and from work today.</p>");
			$("#form_error_modal").modal("show");
			return false;
		}
   });
    
});

</script>

{% endblock %}

{% block body %}

<h2>Check-in your commute to work</h2>

<form id="adultform" action="." method="POST">
	
	{% csrf_token %}

	<fieldset>
		
		<h3>Please tell us about your commute (<span class="required_field">required</span>):</h3>

		<p>
			{% blocktrans %}								
			Please drag and drop the yellow home-marker to the location where you started your commute:
			{% endblocktrans %}
			
		</p>
		
		<div id="map_canvas">map div</div>
		<p id="map_legend" class="small"><img src="{{ STATIC_URL }}img/home.png" height="20" alt="Home marker" > ... {% blocktrans %}your home{% endblocktrans %} <img src="{{ STATIC_URL }}img/factory.png" height="20" alt="Home marker" > ... your work place</p>
		
		<p><a href="#" id="intersection_fields_link">{% trans "...or tell us the street intersection closest to your commute starting point." %}</a></p>
				
		<div id="intersection_fields">
			<div class="clearfix">
				<label>Where do you live?</label>
				<div class="input">
					<select id="home-town-select" tabindex="1">
						<option selected="selected" value="">---------</option>
						{% for town in towns %}<option value="{{ town.slug }}">{{ town.name }}</option> {% endfor %}
					</select>
				</div>
			</div>
			<div class="clearfix">
				{{ adultform.home_street.errors }}
				<label>Your home street:</label> <div class="input">{{ adultform.home_street }}</div>
			</div>
			<div class="clearfix">
				{{ adultform.home_cross_st.errors }}
				<label>Your home cross street:</label><div class="input">{{ adultform.home_cross_st }}</div>
			</div>
		</div>
		
		<div class="clearfix">
			<label>Where do you work?</label>
			<div class="input">
				<select id="work-town-select" tabindex="1">
					<option selected="selected" value="">---------</option>
					{% for town in towns %}<option value="{{ town.slug }}">{{ town.name }}</option> {% endfor %}
				</select>
			</div>
		</div>
		
		<div id="employer_fields">
			<div class="clearfix">
				<label>Please select your place of work:</label>
				<div class="input">
					<select id="employer-select" tabindex="2">
						<option selected="selected" value="">---------</option>
					</select>
				</div>
			</div>
			<div class="clearfix">
				<label>other: </label><div class="input">{{ adultform.other_employer }}</div>
			</div>
			<div class="clearfix">
				<p>Please drag and drop the blue work-place-marker to the correct location if we got it wrong.</p>
			</div>
		</div>
		
		{{ adultform.home_location }}
		{{ adultform.work_location }}
		{{ adultform.distance }}
		{{ adultform.duration }}
		
		<h3>How did you travel to and from work? (<span class="required_field">required</span>)</h3>
		<div class="clearfix">
			{{ adultform.to_work_today.errors }}
			<label>To work today:</label> <div class="input">{{ adultform.to_work_today }}</div>
		</div>
		<div class="clearfix">
			{{ adultform.from_work_today.errors }}
			<label>From work today:</label><div class="input">{{ adultform.from_work_today }}</div>
		</div>

		<div class="clearfix">
			{{ adultform.to_work_yesterday.errors }}
			<label>To work yesterday:</label> <div class="input">{{ adultform.to_work_yesterday }}</div>
		</div>
		<div class="clearfix">
			{{ adultform.from_work_yesterday.errors }}
			<label>From work yesterday:</label><div class="input">{{ adultform.from_work_yesterday }}</div>
		</div>
		
	</fieldset>
		
	<fieldset>
		
		<h3>Your impact</h3>
		
		<div class="clearfix">
			<label>Saved CO2 emissions:</label> <div id="saved_co2" class="uneditable-input"></div>
			<span class="help-block impact">Per EPA standards and assumptions.</span>
			<button id="button_co2" class="btn impact">Calculate CO2</button>
		</div>
		
		<div class="clearfix">
			{{ adultform.weight.errors }}
			<label>Your weight [lbs]:</label> <div class="input">{{ adultform.weight }}</div>
			<label>Your burned calories:</label> <div id="burned_calories" class="uneditable-input"></div>
			<span class="help-block impact">Per <a href="http://prevention.sph.sc.edu/tools/compendium.htm">The Compendium of Physical Activities</a></span>
			<button id="button_calories" class="btn impact">Calculate Calories</button>
		</div>
	</fieldset>
	
	
	<fieldset>
		<h3>Did/will you take advantage of Walk/Ride Day freebies, discounts or raffles at any of our sponsors?</h3>
		<div class="clearfix">
			{{ adultform.sponsor.errors }}
			<label>If yes, which sponsor(s) did you patronize?</label><div class="input">{{ adultform.sponsor }}</div>
		</div>
	</fieldset>
	
    <fieldset>
    	<h3>Contact information (will not share)</h3>
    	<div class="clearfix">
    		{{ adultform.name.errors }}
			<label>Your name (optional)</label><div class="input">{{ adultform.name }}</div>
		</div>
		<div class="clearfix">
			{{ adultform.email.errors }}
			<label>Email (required for raffle)</label><div class="input">{{ adultform.email }}</div>
		</div>
		<div class="clearfix">
			{{ adultform.newsletter.errors }}
			<label>Subscribe to our monthly newsletter?</label><div class="input">{{ adultform.newsletter }}</div>
		</div>
    </fieldset>
    
    <fieldset>
    	<h3>Getting involved</h3>
    	<div class="clearfix">
    		{{ adultform.coordinator.errors }}
			<label>I would like to become a Walk/Ride Day coordinator for my company, school, or other organization (specify organization's name below)</label><div class="input">{{ adultform.coordinator }}</div>
		</div>
		<div class="clearfix">
			{{ adultform.volunteer.errors }}
			<label>I would like to help Green Streets by volunteering in another capacity. (specify how, and please leave your phone number, below)</label><div class="input">{{ adultform.volunteer }}</div>
		</div>
		<div class="clearfix">
			{{ adultform.additional_info.errors }}
			<label>Additional info:</label><div class="input">{{ adultform.additional_info }}</div>
		</div>
    </fieldset>
    
    <fieldset>
    	<h3>Please use the space below to share additional thoughts or feedback. We are always interested in knowing how Walk/Ride Day has affected your lifestyle, decisions and experiences.</h3>
    	<div class="clearfix">
    		{{ adultform.suggestions.errors }}
			<label>Feedback:</label><div class="input">{{ adultform.suggestions }}</div>
		</div>
    </fieldset>	
	
	<button id="button_submit" type="submit" class="btn large primary">Check-in your commute!</button>
	
</form>

<div id="form_error_modal" class="modal hide fade">
	<div class="modal-header">
		<a href="#" class="close">&times;</a>
		<h3>Error</h3>
	</div>
	<div id="form_error_msg" class="modal-body"></div>
</div>

{% endblock %}