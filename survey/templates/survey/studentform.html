{% extends "base.html" %}
{% load i18n %}

{% block javascript %}
<link href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/base/jquery-ui.css" rel="stylesheet" type="text/css"/>
<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/jquery-ui.min.js"></script>
<script src="{{ STATIC_URL }}js/jquery.shuffle.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}js/jquery.cookie.js" type="text/javascript"></script>
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false&language={{ LANGUAGE_CODE }}"></script> 
<script type="text/javascript">

$(document).ready(function() {
	
	// check if cookies are enabled
	$.cookie('test_cookie', 'testing', { path: '/' });
	if ($.cookie('test_cookie') !== 'testing') {
		alert("Please allow cookies for this site in your browser, otherwise the survey form might not work. Thank you!");
	}

	var boston = new google.maps.LatLng(42.357778, -71.061667);
	var school = new google.maps.LatLng(42.37, -71.08);
	var home = new google.maps.LatLng(42.36, -71.10);
	
	var mapOptions = {
		zoom: 11,
		mapTypeId: google.maps.MapTypeId.ROADMAP,
		center: home
	};
 
	var map = new google.maps.Map(document.getElementById("map_canvas"),
		mapOptions);
    
    var iconSchool = "{{ STATIC_URL }}img/school.png";
	var markerSchool = new google.maps.Marker({
		map:map,
		title:"{{ school.name }}",
		position: school,
		icon: iconSchool
	});
	var iconHome = "{{ STATIC_URL }}img/home.png";
	var markerHome = new google.maps.Marker({
		map:map,
		title:"Please drag & drop the marker to the intersection closest to your home",
		draggable:true,
		animation: google.maps.Animation.DROP,
		position: home,
		icon: iconHome
	});
	// animation
	google.maps.event.addListener(markerHome, 'click', toggleBounce);
	// track marker dragging		
	google.maps.event.addListener(markerHome, 'dragend', function() {
		// write loc coord to hidden geometry field (in WGS84)
		$("#id_home_location").val("POINT (" + markerHome.position.lng() + " " +  markerHome.position.lat() + ")");
	});
	
	function toggleBounce() {
		if (markerH.getAnimation() != null) {
			markerH.setAnimation(null);
		} else {
			markerH.setAnimation(google.maps.Animation.BOUNCE);
		}
	}
	
	
	$("#school-select-container").hide();
	$("#school-district-select").change(function() {
    	var district = $("#school-district-select option:selected").val();
    	var school_locations = {};
    	$.getJSON("/district/" + district + "/schools/", function(schools) {
    		// remove previous schools
    		$("#school-select option").remove();
    		$("<option selected='selected' value=''>---------</option>").appendTo("#school-select");
    		$.each(schools, function(id, school) {
				$("<option value='" + id + "'>" + school.name + "</option>").appendTo("#school-select");
				school_locations[id] = school.latlon;
			});
			// bind change event to select input
			$("#school-select").change(function () {
				var school_id = $("#school-select option:selected").val();
				// var name = $("#employer-select option:selected").text();
				var coords = school_locations[school_id];
				var location = new google.maps.LatLng(coords.split(" ")[0], coords.split(" ")[1]);
				markerSchool.setPosition(location);
				$("#id_school").val(school_id);
			});
    		$("#school-select-container").show(500);
    	});
    	
	});
	
	/***********************
	 *  children formsets  *
	 ***********************/
	
	var nrChildForms = $("#id_child_set-TOTAL_FORMS").val() - 1;
	
	// child-form counter
	// FIXME: count childforms, otherwise errorform breaks
	var childCount = 0;
	
	// form validation: min information is location and child mode
	var validation = {
		"formerror":{% if formerror %} true {% else %} false {% endif %},
		"marker": false // location not set
	};
	
	$("#surveyform").submit(function() {
		// check location field
		if ($("#id_location").val() === "POINT (0.0000000000000000 0.0000000000000000)") {
			validation.marker = false;
		} else {
			// required for django validation error page-reload
			validation.marker = true;
		}
		
      	// no location provided, harder to check with django form validation
		if (validation.marker === false && ($("#id_street").val() === "" || $("#id_cross_st").val() === "")) {
			alert("Please provide your street information.");
	      	return false;
		}
   });
	
	// FIXME: create a function for checking dropoff/pickup options
	
	// add another child
	$("#button_addchild").click(function() {
		
		// clone last child-form
		var $childformClone = $("#id_child_set-" + childCount).clone();
		
		// update form attributes in clone to new child
    	$childformClone
		.attr("id", "id_child_set-" + (childCount+1))
		.find("input,select,label")
		.each(function(index) {
			if ($(this).is("select") || $(this).is("input")) {
				newId = $(this).attr("id").replace("id_child_set-" + childCount,"id_child_set-" + (childCount+1));
				newName = $(this).attr("name").replace("child_set-" + childCount,"child_set-" + (childCount+1));
				$(this)
				.attr("id", newId)
				.attr("name", newName);    				
			}
			if ($(this).is("label")) {
				newAttr = $(this).attr("for").replace("id_child_set-" + childCount,"id_child_set-" + (childCount+1));
				$(this).attr("for", newAttr);
			}
		});
		
		// append clone to page
		$childformClone.appendTo("#children").slideDown(500);
		$('html, body').animate({
			scrollTop: $childformClone.offset().top - 50 
		}, 500);
		// increase counter
		childCount++;
		// update management form number (form-id count starts at, real number at 1, that's why it must be +1)
		$("#id_child_set-TOTAL_FORMS").val(childCount+1);
		//
		$("#impact_header").text("Your children's impact");
		// don't submit form
		return false;
	});	
	
	// catch django form validation error page-reload
	// bind dropoffDetail function to start form
    // if (!validation.formerror) $("#id_child_set-0-from_school, #id_child_set-0-to_school").dropoffDetails(0);
    
    // random order of modes
    $("#id_child_set-0-to_school, #id_child_set-0-from_school").shuffle();
    
    // hide and show optional street intersection fields
    $("#intersection_fields").hide();
    $("#intersection_fields_link").click(function () {
    	$("#intersection_fields").toggle(500);
		return false;
    });
    
    $("#home-town-select").change(function() {
    	var town = $("#home-town-select option:selected").val();
		// simple street type-ahead to limit street options
		$.getJSON("/town/" + town + "/streets/", function(streets) {
			$("input#id_home_street, input#id_home_cross_st").autocomplete({
				source: streets,
				minLength: 3
			});
		});
    });
    
});

</script>

{% endblock %}

{% block body %}

<h2>Check-in your child's commute to school</h2>

<form id="surveyform" action="." method="POST">
	
	{% csrf_token %}
	
	{{ surveyformset.management_form }}

	<fieldset>
		
		<h3>Please tell us about your child's commute (<span class="required_field">required</span>):</h3>

		<p>
			{% blocktrans %}								
			Please drag and drop the yellow home-marker to an intersection on your street, near your home:
			{% endblocktrans %}
			
		</p>
		
		<div id="map_canvas">map div</div>
		<p id="map_legend" class="small"><img src="{{ STATIC_URL }}img/home.png" height="20" alt="Home marker" > ... your home <img src="{{ STATIC_URL }}img/school.png" height="20" alt="Home marker" > ... your child's school</p>
		
		<p><a href="#" id="intersection_fields_link">{% trans "...or tell us the street intersection closest to your home." %}</a></p>
		
		<div id="intersection_fields">
			<div class="clearfix">
				<label>Where do you live?</label>
				<div class="input">
					<select id="home-town-select" tabindex="1">
						<option selected="selected" value="">---------</option>
						{% for town in towns %}<option value="{{ town.slug }}">{{ town.name }}</option> {% endfor %}
					</select>
				</div>
			</div>
			<div class="clearfix">
				{{ surveyform.home_street.errors }}
				<label>{% trans surveyform.home_street.label %}:</label> <div class="input">{{ surveyform.home_street }}</div>
			</div>
			<div class="clearfix">
				{{ surveyform.home_cross_st.errors }}
				<label>{% trans surveyform.home_cross_st.label %}:</label><div class="input">{{ surveyform.home_cross_st }}</div>
			</div>
		</div>
		
		<div class="clearfix">
			<label>Where does your child go to school?</label>
			<div class="input">
				<select id="school-district-select" tabindex="1">
					<option selected="selected" value="">---------</option>
					{% for district in districts %}<option value="{{ district.slug }}">{{ district.distname }}</option> {% endfor %}
				</select>
			</div>
		</div>
		<div id="school-select-container" class="clearfix">
			<label>Please select your child's school:</label>
			<div class="input">
				<select id="school-select" tabindex="2"></select>
			</div>
		</div>
		
		{{ surveyform.home_location }}
		{{ surveyform.distance }}
		{{ surveyform.duration }}
		{{ surveyform.school }}
		
	</fieldset>
	
	<div id="children">
		
		<h3>How does your child travel to and from school? (<span class="required_field">required</span>)</h3>
		
		{% for form in surveyformset.forms %}
		
			<fieldset id="id_child_set-0">

			{% for field in form %}
			
				{% if not field.is_hidden %}
				
					{% if field.errors %}
						<div class="alert-message block-message error">
						{% for error in field.errors %}
							{{ error|escape }}<br />
						{% endfor %}
							<label>{{ field.label|safe }}</label><div class="input">{{ field }}</div>
						</div>
					{% else %}
						<div class="clearfix">
							<label>{{ field.label|safe }}</label><div class="input">{{ field }}</div>
						</div>
					{% endif %}
				
				{% else %}
					{{ field }}
				{% endif %}
			{% endfor %}

			</fieldset>
		
		{% endfor %}
	
	</div>
	
	<button id="button_addchild" class="btn">{% trans "Add another child at this school" %}</button>	
	
	<fieldset>
		<h3>Did/will you take advantage of Walk/Ride Day freebies, discounts or raffles at any of our sponsors?</h3>
		<div class="clearfix">
			{{ surveyform.sponsor.errors }}
			<label>If yes, which sponsor(s) did you patronize?</label><div class="input">{{ surveyform.sponsor }}</div>
		</div>
	</fieldset>
	
    <fieldset>
    	<h3>Contact information (will not share)</h3>
    	<div class="clearfix">
    		{{ surveyform.name.errors }}
			<label>Your name (optional)</label><div class="input">{{ surveyform.name }}</div>
		</div>
		<div class="clearfix">
			{{ surveyform.name.errors }}
			<label>Email (required for raffle)</label><div class="input">{{ surveyform.name }}</div>
		</div>
		<div class="clearfix">
			{{ surveyform.newsletter.errors }}
			<label>Subscribe to our monthly newsletter?</label><div class="input">{{ surveyform.newsletter }}</div>
		</div>
    </fieldset>
    
    <fieldset>
    	<h3>Getting involved</h3>
    	<div class="clearfix">
    		{{ surveyform.coordinator.errors }}
			<label>I would like to become a Walk/Ride Day coordinator for my company, school, or other organization (specify organization's name below)</label><div class="input">{{ surveyform.coordinator }}</div>
		</div>
		<div class="clearfix">
			{{ surveyform.volunteer.errors }}
			<label>I would like to help Green Streets by volunteering in another capacity. (specify how, and please leave your phone number, below)</label><div class="input">{{ surveyform.volunteer }}</div>
		</div>
		<div class="clearfix">
			{{ surveyform.additional_info.errors }}
			<label>Additional info:</label><div class="input">{{ surveyform.additional_info }}</div>
		</div>
    </fieldset>
    
    <fieldset>
    	<h3>Please use the space below to share additional thoughts or feedback. We are always interested in knowing how Walk/Ride Day has affected your lifestyle, decisions and experiences.</h3>
    	<div class="clearfix">
    		{{ surveyform.suggestions.errors }}
			<label>Feedback:</label><div class="input">{{ surveyform.suggestions }}</div>
		</div>
    </fieldset>	

	
	<button id="button_submit" type="submit" class="btn large primary">{% trans "Submit Survey" %}</button>
	

</form>


{% endblock %}