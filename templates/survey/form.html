{% extends "base.html" %}
{% load i18n %}
{% load dbgettext_tags %}

{% block style %}

	select, input {
		margin-left: 10px;
		margin-right: 10px;
	}
	#button_addchild {
		margin-bottom: 18px;
	}
	#map_canvas {
		width: 100%; 
		height: 400px;
	}
	#map_legend {
		text-align: right;
	}
	#map_legend img {
		height: 16px;
	}

{% endblock %}

{% block javascript %}
<script src="http://ajax.aspnetcdn.com/ajax/jquery/jquery-1.5.2.min.js" type="text/javascript"></script>
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false&language={{ LANGUAGE_CODE }}"></script> 
<script type="text/javascript">

$(document).ready(function() {

{% if school %}

	// setting marker location
	var school = new google.maps.LatLng({{ school.location.y }}, {{ school.location.x }});
	
	// parsing hidden home location field
	var homeCoord = $("#id_location")
	.val()
	.substr(7, ($("#id_location").val().length - 8))
	.split(" ");
	
	// if we have a home location, render it
	if (parseFloat(homeCoord[0]) === 0) {
		var home = new google.maps.LatLng({{ school.location.y }}+0.002, {{ school.location.x }}-0.002);
	} else {
		var home = new google.maps.LatLng(homeCoord[1], homeCoord[0]);
	}
	// setting school id
	$("#id_school").val({{ school.id }});
	
{% else %}

	var school = new google.maps.LatLng(42.34, -71.0);
	var home = new google.maps.LatLng(42.335, -70.995);
	
{% endif %}
	
	var mapOptions = {
		zoom: 14,
		mapTypeId: google.maps.MapTypeId.ROADMAP,
		center: school
	};
 
	var map = new google.maps.Map(document.getElementById("map_canvas"),
		mapOptions);
    
    var iconSchool = "{{ MEDIA_URL }}img/school.png";
	var markerSchool = new google.maps.Marker({
		map:map,
		title:"{{ school.name }}",
		position: school,
		icon: iconSchool
	});
	var iconHome = "{{ MEDIA_URL }}img/home.png";
	var markerHome = new google.maps.Marker({
		map:map,
		title:"Please drag & drop the marker to the intersection closest to your home",
		draggable:true,
		animation: google.maps.Animation.DROP,
		position: home,
		icon: iconHome
	});
	// animation
	google.maps.event.addListener(markerHome, 'click', toggleBounce);
	// track marker dragging		
	google.maps.event.addListener(markerHome, 'dragend', function() {
		// write loc coord to hidden geometry field (in WGS84)
		$("#id_location").val("POINT (" + markerHome.position.lng() + " " +  markerHome.position.lat() + ")");
		// validate location
		validation["marker"] = true;
	});
	
	function toggleBounce() {
		if (markerH.getAnimation() != null) {
			markerH.setAnimation(null);
		} else {
			markerH.setAnimation(google.maps.Animation.BOUNCE);
		}
	}
	
	/***********************
	 *  children formsets  *
	 ***********************/
	
	// child-form counter
	// FIXME: count childforms, otherwise errorform breaks
	var childCount = 0;
	
	// form validation: min information is location and child mode
	var validation = {
		"formerror":{% if formerror %} true {% else %} false {% endif %},
		"marker": false // location not set
	};
	
	/* $('#other').click(function() {
  $('#target').submit();
}); */
	
	$("#surveyform").submit(function() {
		// check location field
		if ($("#id_location").val() === "POINT (0.0000000000000000 0.0000000000000000)") validation.marker = false;
		
      	// no location provided, harder to check with django form validation
		if (validation.marker === false && ($("#id_street").val() === "" || $("#id_cross_st").val() === "")) {
			alert("Please provide your street information.");
	      	return false;
		}
   });
		
	// dropoff detail functionality
	$.fn.dropoffDetails = function(child) {
		// reset and hide id_child_set-0-dropoff_to|_from fieldset
    	$("#id_child_set-" + child + "-dropoff, #id_child_set-" + child + "-pickup")
    	.each(function(index) {
    		$(this).parentsUntil("#id_child_set-" + child).hide();
    	});
		// bind change event to travelmode fields
		$(this).change(function() {
			// check for direction if child pickup or dropoff
    		direction = ($(this).attr("id").indexOf("from_school") >= 0) ? "pickup" : "dropoff";
			// check if selected value is in list of modes
			if ( $.inArray($(this).val(), ["fv", "cp"]) >= 0 ) { // show additional question
				$("#id_child_set-" + child + "-" + direction).parentsUntil("#id_child_set-" + child).show(500);				
			} else { // hide and clear value
				$("#id_child_set-" + child + "-" + direction).parentsUntil("#id_child_set-" + child).hide(500);
				$("#id_child_set-" + child + "-" + direction).val("");
			}
		});
	}
	
	// FIXME: create a function for checking dropoff/pickup options
	
	// add another child
	$("#button_addchild").click(function() {
		
		// clone last child-form
		var $childformClone = $("#id_child_set-" + childCount).clone();
		
		// update form attributes in clone to new child
    	$childformClone
		.attr("id", "id_child_set-" + (childCount+1))
		.find("input,select,label")
		.each(function(index) {
			if ($(this).is("select") || $(this).is("input")) {
				newId = $(this).attr("id").replace("id_child_set-" + childCount,"id_child_set-" + (childCount+1));
				newName = $(this).attr("name").replace("child_set-" + childCount,"child_set-" + (childCount+1));
				$(this)
				.attr("id", newId)
				.attr("name", newName);    				
			}
			if ($(this).is("label")) {
				newAttr = $(this).attr("for").replace("id_child_set-" + childCount,"id_child_set-" + (childCount+1));
				$(this).attr("for", newAttr);
			}
		});
		
		// append clone to page
		$childformClone.appendTo("#children").slideDown(500);
		
		$('html, body').animate({
			scrollTop: $("#button_submit").offset().top 
		}, 1000);
		// bind dropoffDetail function to cloned form
		$("#id_child_set-" + (childCount+1) + "-from_school, #id_child_set-" + (childCount+1) + "-to_school").dropoffDetails(childCount+1);
		// increase counter
		childCount++;
		// update management form number (form-id count starts at, real number at 1, that's why it must be +1)
		$("#id_child_set-TOTAL_FORMS").val(childCount+1);
		// don't submit form
		return false;
	});	
	
	// bind dropoffDetail function to start form
	// don't when page is loaded due to django form validation error
    if (!validation.formerror) $("#id_child_set-0-from_school, #id_child_set-0-to_school").dropoffDetails(0);
    
});

</script>

{% endblock %}

{% block body %}

{% if school %}

<div class="prepend-2 span-20 append-2 last {{ LANGUAGE_CODE }}">
	
	<h1>{{ school.name }}</h1>
	
	<h2>
		{% blocktrans %}
		Important School Travel Survey
		{% endblocktrans %}
	</h2>
	
	<p><strong>
		{% blocktrans %}
		Dear Parent or Guardian,
		{% endblocktrans %}
	</strong></p>
 
	<p>{{ school.name }} would like to learn how students get to and from school. 
		{% blocktrans %}
		This information will be used to plan safe and healthy walking options for students.
		{% endblocktrans %}
	</p>
		
	<p><em>
		{% blocktrans %}
		This survey will take less than 3 minutes to complete.
		{% endblocktrans %}
	</em></p>
	
	<p>
		{% blocktrans %}
		Please complete one survey for each child at this school by <strong>Friday, May 20</strong>.
		{% endblocktrans %}
	</p>

	<p><strong>
		{% blocktrans %}
		Your school earns money when you complete this survey!
		{% endblocktrans %}
	</strong><br>	
		{% trans school.survey_incentive %}
	</p>
		
	<p><strong>
		{% blocktrans %}
		Please do not complete the online survey if you have already submitted a paper copy.
		{% endblocktrans %}
		</strong>
	</p>
	
	 
	
	<form id="surveyform" action="." method="POST">
		
		{% csrf_token %}
		
		{{ surveyformset.management_form }}
		
		<fieldset class="module aligned">
			
			<p class="large">
				{% blocktrans %}
				What street do you live on?
				{% endblocktrans %}
			</p>
	
			<p>
				{% blocktrans %}								
				Please drag and drop the yellow home-marker to an intersection on your street, near your home:
				{% endblocktrans %}
				
			</p>
			
			<div id="map_canvas">map div</div>
			<div id="map_legend" class="small"><img src="{{ MEDIA_URL }}img/home.png" height="20" alt="Home marker" > ... home marker <img src="{{ MEDIA_URL }}img/school.png" height="20" alt="Home marker" > ... {{ school.name }}</div>
			
			<p>
				{% blocktrans %}
				...or tell us the street intersection closest to your home.
				{% endblocktrans %}
			</p>
			
			<div class="form-row">
				
					{{ surveyform.street.errors }}
					{{ surveyform.street.label }}: {{ surveyform.street }}<br>
					{{ surveyform.cross_st.errors }}
					{{ surveyform.cross_st.label }}: {{ surveyform.cross_st }}
			
			</div>
			
			{{ surveyform.location }}
			
		</fieldset>
		
		<div id="children">
		
			{% for form in surveyformset.forms %}
		
			<fieldset id="id_child_set-0" class="module aligned">
			
			{% for field in form %}
			
				{% if not field.is_hidden %}
				<div class="form-row">
					<div class="field-box">											
						
						{% if field.errors %}
								<div class="error">
							{% for error in field.errors %}
							    	{{ error|escape }}<br>
							{% endfor %}
									<span class="large">{{ field.label }}</span> {{ field }}
								</div>
						{% else %}
							<span class="large">{{ field.label }}</span> {{ field }}
						{% endif %}
					</div>
				</div>
				{% else %}
					{{ field }}
				{% endif %}
			{% endfor %}
			
			</fieldset>
		
			{% endfor %}
		
		</div>
		
		<button id="button_addchild">
			{% blocktrans %}
			Add another child at this school
			{% endblocktrans %}
		</button>
		
		<fieldset class="module aligned">
		
			<div class="form-row">
				<div class="field-box">
					
					{% if surveyform.nr_vehicles.errors %}
						<div class="error">
						{% for error in surveyform.nr_vehicles.errors %}
						    {{ error|escape }}<br>
						{% endfor %}
							<span class="large">{{ surveyform.nr_vehicles.label }}</span> {{ surveyform.nr_vehicles }}
						</div>
					{% else %}
						<span class="large">{{ surveyform.nr_vehicles.label }}</span> {{ surveyform.nr_vehicles }}
					{% endif %}
					
				</div>
			</div>
			
			<div class="form-row">
				<div class="field-box">
					
					{% if surveyform.nr_licenses.errors %}
						<div class="error">
						{% for error in surveyform.nr_licenses.errors %}
						    {{ error|escape }}<br>
						{% endfor %}
							<span class="large">{{ surveyform.nr_licenses.label }}</span> {{ surveyform.nr_licenses }}
						</div>
					{% else %}
						<span class="large">{{ surveyform.nr_licenses.label }}</span> {{ surveyform.nr_licenses }}
					{% endif %}
					
				</div>
			</div>
		
		</fieldset>
		
		<button id="button_submit" type="submit">
			{% blocktrans %}
			Submit Survey
			{% endblocktrans %}
		</button>
	
	</form>
		
</div>

{% endif %}

{% endblock %}