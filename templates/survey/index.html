{% extends "base.html" %}
{% load i18n %}

{% block javascript %}
<script src="http://ajax.aspnetcdn.com/ajax/jquery/jquery-1.5.1.min.js" type="text/javascript"></script>
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script> 
<script type="text/javascript">

$(document).ready(function()
    {
    
	{% if school %}
		
		// setting marker location
		var school = new google.maps.LatLng({{ school.location.y }}, {{ school.location.x }});
		var home = new google.maps.LatLng({{ school.location.y }}+0.002, {{ school.location.x }}-0.002);
		// setting school id
		$("#id_school").val({{ school.id }});
	    
	{% else %}
	
		var school = new google.maps.LatLng(42.34, -71.0);
		var home = new google.maps.LatLng(42.335, -70.995);
		
	{% endif %}
    	
    	var mapOptions = {
			zoom: 14,
			mapTypeId: google.maps.MapTypeId.ROADMAP,
			center: school
		};
	 
		var map = new google.maps.Map(document.getElementById("map_canvas"),
			mapOptions);
	    
	    var iconSchool = "{{ MEDIA_URL }}img/school.png";
		var markerSchool = new google.maps.Marker({
			map:map,
			title:"{{ school.name }}",
			position: school,
			icon: iconSchool
		});
		var iconHome = "{{ MEDIA_URL }}img/home.png";
		var markerHome = new google.maps.Marker({
			map:map,
			title:"Please drag & drop the marker to the intersection closest to your home",
			draggable:true,
			animation: google.maps.Animation.DROP,
			position: home,
			icon: iconHome
		});
		// animation
		google.maps.event.addListener(markerHome, 'click', toggleBounce);
		// track marker dragging		
		google.maps.event.addListener(markerHome, 'dragend', function() {
			// write loc coord to hidden geometry field (in WGS84)
			$("#id_location").val("POINT (" + markerHome.position.lng() + " " +  markerHome.position.lat() + ")");
		});
    	
    	/***********************
    	 *  children formsets  *
    	 ***********************/
    	
    	var childCount = 0;
    	
		// dropoff detail functionality
    	$.fn.dropoffDetails = function(child) {
    		// reset and hide id_child_set-0-dropoff_to|_from fieldset
	    	$("#id_child_set-" + childCount + "-dropoff_to, #id_child_set-" + childCount + "-dropoff_from")
	    	.each(function(index) {
	    		$(this).parentsUntil("#id_child_set-" + childCount).hide();
	    	});
    		// bind change event
    		$(this).change(function() {
    			// check for direction
	    		direction = ($(this).attr("id").indexOf("from_school") >= 0) ? "from" : "to";
				// check if selected value is in list of modes
				if ( $.inArray($(this).val(), ["fv", "cp"]) >= 0 ) { // show additional question
					$("#id_child_set-" + child + "-dropoff_" + direction).parentsUntil("#id_child_set-" + child).show(500);
					// scroll to show buttons again
					$('html, body').animate({
						scrollTop: $("#button_submit").offset().top 
					}, 1000);					
				} else { // hide and clear value
					$("#id_child_set-" + child + "-dropoff_" + direction).parentsUntil("#id_child_set-" + child).hide(500);
					$("#id_child_set-" + child + "-dropoff_" + direction).val("");
				}
			});
    	}
    	
    	// bind dropoffDetail function to start form
	    // $("#id_child_set-" + childCount + "-from_school, #id_child_set-" + childCount + "-to_school").dropoffDetails(0);
    	
    	// add another child
		$("#button_addchild").click(function() {
    		// clone fieldset
    		$("#id_child_set-" + childCount).clone().appendTo("#children").slideDown(500);
    		// change fieldset id
    		$("#id_child_set-" + childCount + ":first").attr("id", "id_child_set-" + (childCount+1));
    		// scroll to show buttons
			$('html, body').animate({
				scrollTop: $("#button_submit").offset().top 
			}, 1000);
    		// update input|select:'id'&'name' and label:'for' in all fieldsets
    		$("#id_child_set-" + (childCount+1))
    		.find("input,select,label")
    		.each(function(index) {
    			if ($(this).is("select") || $(this).is("input")) {
    				newId = $(this).attr("id").replace("id_child_set-" + childCount,"id_child_set-" + (childCount+1));
    				newName = $(this).attr("name").replace("child_set-" + childCount,"child_set-" + (childCount+1));
    				$(this)
 					.attr("id", newId)
    				.attr("name", newName);    				
    			}
    			if ($(this).is("label")) {
    				newAttr = $(this).attr("for").replace("id_child_set-" + childCount,"id_child_set-" + (childCount+1));
    				$(this).attr("for", newAttr);
    			}
			});
    		// bind dropoffDetail function to cloned form
    		// $("#id_child_set-" + (childCount+1) + "-from_school, #id_child_set-" + (childCount+1) + "-to_school").dropoffDetails(childCount+1);
    		// increase counter
    		childCount++;
    		// update management form number (form-id count starts at, real number at 1, that's why it must be +1)
    		$("#id_child_set-TOTAL_FORMS").val(childCount+1);
    		// don't submit form
    		return false;
		});		
    });
    
	function toggleBounce() {
		if (markerH.getAnimation() != null) {
			markerH.setAnimation(null);
		} else {
			markerH.setAnimation(google.maps.Animation.BOUNCE);
		}
	}
	
</script>

{% endblock %}

{% block body %}

{% if school %}

<div class="prepend-2 span-20 append-2 last">
	<h1>{{ school.name }}</h1>
	
	<h2>Important School Travel Survey</h2>
	
	<p>Dear Parent or Caregiver,</p>
 
	<p><strong>Brockton Elementary would like to learn how students get to and from school.</strong><br> 
	This information will be used to plan safe and healthy transportation options for all students. Please provide this survey by <strong>Thursday April 7</strong> for each child in your familiy at this school.</p>

	<p><strong>If at least half of our students return surveys, WalkBoston will donate $250 to the parent committee fund.  A 75% response rate will result in a donation of $400!</strong></p>
	
	<h3>Please drag & drop the home-marker to the intersection closest to your home</h3>
	
	<div id="map_canvas" style="width: 100%; height: 400px;">map div</div>
	
	<form id="surveyform" action="." method="POST">
		
		{% csrf_token %}
		
		{{ surveyformset.management_form }}
		
		<fieldset class="module aligned">
		
		{% for field in surveyform %}
			{% if not field.is_hidden %}
			<div class="form-row">
				<div class="field-box">
					{{ field.errors }}
					{{ field.label_tag }}: {{ field }}
				</div>
			</div>
			{% else %}
				{{ field }}
			{% endif %}
		{% endfor %}
		
		</fieldset>
		
		<div id="children">
		
			{% for form in surveyformset.forms %}
		
			<fieldset id="id_child_set-0" class="module aligned">
			
			{% for field in form %}
				{% if not field.is_hidden %}
				<div class="form-row">
					<div class="field-box">
						{{ field.errors }}
						{{ field.label_tag }}: {{ field }}
					</div>
				</div>
				{% else %}
					{{ field }}
				{% endif %}
			{% endfor %}
			
			</fieldset>
		
			{% endfor %}
		
		</div>
		
		<button id="button_addchild">Add Another Child at this School</button>
		<input id="button_submit" type="submit" value="Submit" />
	
	</form>
		
</div>

{% endif %}


{% endblock %}